function[lny,sigma,tau,phi]=Akkar2014(To,M,Rhyp,Rjb,Repi,VS30,SOF,model,adjfun)
% Syntax : Akkar2014 SOF model                                              

st = dbstack;
[isadmisible,units] = isIMadmisible(To,st(1).name,[0 4],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

if To>=0
    To      = max(To,0.001);
end
period = [-1,0.001,0.01,0.02,0.03,0.04,0.05,0.075,0.1,0.15,0.2,0.3,0.4,0.5,0.75,1,1.5,2,3,4];
T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6); % Identify the period

PGAref = exp(gmpe(2,M,Rhyp,Rjb,Repi,VS30,SOF,model,[]));

if T_lo==T_hi
    [lny,tau,phi] = gmpe(index,M,Rhyp,Rjb,Repi,VS30,SOF,model,PGAref);
else
    [lny_lo,tau_lo,phi_lo] = gmpe(index,  M,Rhyp,Rjb,Repi,VS30,SOF,model,PGAref);
    [lny_hi,tau_hi,phi_hi] = gmpe(index+1,M,Rhyp,Rjb,Repi,VS30,SOF,model,PGAref);
    x          = log([T_lo;T_hi]);
    Y_sa       = [lny_lo,lny_hi]';
    Y_sigma2   = [tau_lo,tau_hi]';
    Y_sigma1   = [phi_lo,phi_hi]';
    lny        = interp1(x,Y_sa,log(To))';
    phi        = interp1(x,Y_sigma2,log(To))';
    tau        = interp1(x,Y_sigma1,log(To))';
end
sigma = sqrt(tau.^2+phi.^2);

% unit convertion
lny  = lny+log(units);

% modifier
if exist('adjfun','var')
    SF  = feval(adjfun,To); 
    lny = lny+log(SF);
end


function[lny,tau,phi]=gmpe(index,M,Rhyp,Rjb,Repi,VS30,SOF,model,PGAref)

FN=0;FR=0;
switch SOF
    case 'strike-slip'
    case 'normal'          , FN = 1;
    case 'normal-oblique'  , FN = 1;
    case 'reverse'         , FR = 1;
    case 'reverse-oblique' , FR = 1;
    case 'unspecified'
end

switch model
    case 'rhyp' , R=Rhyp;
    case 'rjb'  , R=Rjb;
    case 'repi' , R=Repi;
end

C = getAkkae2014coefficients(index,model);

a1   = C(1);
a3   = C(2);
a4   = C(3);
a8   = C(4);
a9   = C(5);
b1   = C(6);
b2   = C(7);
phi  = C(8);
tau  = C(9);

a2 = 0.0029;
a5 = 0.2529;
a6 = 7.5;
a7 = -0.5096;
c1 = 6.75;
c  = 2.5;
n  = 3.2;

% Magnitude and site term
M1 = M(M<=c1);
M2 = M(M> c1);
lnref        = nan(size(M));
lnref(M<=c1) = a1+a2*(M1-c1)+a3*(8.5-M1).^2+(a4+a5*(M1-c1)).*log(sqrt(R(M<=c1).^2+a6^2))+a8*FN+a9*FR;
lnref(M> c1) = a1+a7*(M2-c1)+a3*(8.5-M2).^2+(a4+a5*(M2-c1)).*log(sqrt(R(M> c1).^2+a6^2))+a8*FN+a9*FR;

% site term
VREF  = 750;
VCON  = 1000;
vrat  = VS30/VREF;
Vmin  = min(VS30,VCON);
if VS30<=VREF && ~isempty(PGAref)
    lnS = b1*log(vrat)+b2*log((PGAref+c*vrat^n)./((PGAref+c)*vrat^n));
else
    lnS = b1*log(Vmin/VREF);
end

lny = lnref + lnS;



function[C]=getAkkae2014coefficients(index,model)

switch model
    case 'rjb'
        switch index
            case 1,  C=[5.61201 -0.0998 -0.98388 -0.0616 0.063 -0.72057 -0.19688 0.6014 0.3311 0.6865   ];
            case 2,  C=[1.85329 -0.02807 -1.23452 -0.1091 0.0937 -0.41997 -0.28846 0.6201 0.3501 0.7121 ];
            case 3,  C=[1.87032 -0.0274 -1.23698 -0.1115 0.0953 -0.41729 -0.28685 0.6215 0.3526 0.7146  ];
            case 4,  C=[1.95279 -0.02715 -1.25363 -0.104 0.1029 -0.39998 -0.28241 0.6266 0.3555 0.7204  ];
            case 5,  C=[2.07006 -0.02403 -1.27525 -0.0973 0.1148 -0.34799 -0.26842 0.641 0.3565 0.7335  ];
            case 6,  C=[2.20452 -0.01797 -1.30123 -0.0884 0.1073 -0.27572 -0.24759 0.6534 0.3484 0.7405 ];
            case 7,  C=[2.35413 -0.01248 -1.32632 -0.0853 0.1052 -0.21231 -0.22385 0.6622 0.3551 0.7514 ];
            case 8,  C=[2.63078 -0.00532 -1.35722 -0.0779 0.0837 -0.14427 -0.17525 0.6626 0.3759 0.7618 ];
            case 9,  C=[2.85412 -0.00925 -1.38182 -0.0749 0.0761 -0.27064 -0.29293 0.667 0.4067 0.7812  ];
            case 10, C=[2.96622 -0.02193 -1.3646 -0.0265 0.0545 -0.48313 -0.39551 0.6796 0.3893 0.7832  ];
            case 11, C=[2.73872 -0.03462 -1.28877 0 0.0493 -0.65315 -0.44644 0.6645 0.3842 0.7676  ];
            case 12, C=[2.3015 -0.05672 -1.17072 0 0.0469 -0.82609 -0.4573 0.6599 0.3816 0.7623    ];
            case 13, C=[1.89372 -0.07684 -1.0653 0 0.04 -0.89517 -0.43008 0.6697 0.3962 0.7781     ];
            case 14, C=[1.67127 -0.0949 -1.01909 0 0.0271 -0.94614 -0.37408 0.6512 0.4021 0.7653   ];
            case 15, C=[0.95211 -0.12347 -0.88393 0 0.0141 -1.00786 -0.28957 0.6744 0.4043 0.7863  ];
            case 16, C=[0.52349 -0.14345 -0.81838 0 0 -1.01331 -0.28702 0.6787 0.3943 0.7849       ];
            case 17, C=[-0.01867 -0.17187 -0.75751 0 0 -0.98071 -0.24695 0.7164 0.3799 0.8109      ];
            case 18, C=[-0.42891 -0.19029 -0.72033 0 -0.009 -0.91007 -0.17336 0.7254 0.3717 0.8151 ];
            case 19, C=[-1.05642 -0.21392 -0.69085 0 -0.0683 -0.85793 -0.13336 0.6997 0.4046 0.8083];
            case 20, C=[-1.37536 -0.23848 -0.66482 0 -0.2231 -0.75645 -0.07749 0.6196 0.3566 0.7149];
        end
    case 'repi'
        switch index
            case 1,  C=[6.13498 -0.12091 -1.04013 -0.0616 0.063 -0.72057 -0.19688 0.6143 0.3485 0.7063  ];
            case 2,  C=[2.52977 -0.05496 -1.31001 -0.1091 0.0937 -0.41997 -0.28846 0.6375 0.3581 0.7312 ];
            case 3,  C=[2.54832 -0.05434 -1.31268 -0.1115 0.0953 -0.41729 -0.28685 0.6389 0.3607 0.7337 ];
            case 4,  C=[2.6442 -0.05452 -1.33135 -0.104 0.1029 -0.39998 -0.28241 0.6434 0.3615 0.738    ];
            case 5,  C=[2.77723 -0.05196 -1.35509 -0.0973 0.1148 -0.34799 -0.26842 0.6569 0.3617 0.7499 ];
            case 6,  C=[2.92666 -0.04657 -1.38259 -0.0884 0.1073 -0.27572 -0.24759 0.6693 0.353 0.7567  ];
            case 7,  C=[3.09355 -0.04168 -1.41008 -0.0853 0.1052 -0.21231 -0.22385 0.6773 0.3612 0.7676 ];
            case 8,  C=[3.38462 -0.03506 -1.44268 -0.0779 0.0837 -0.14427 -0.17525 0.6791 0.3853 0.7808 ];
            case 9,  C=[3.61906 -0.03936 -1.4687 -0.0749 0.0761 -0.27064 -0.29293 0.6851 0.416 0.8015   ];
            case 10, C=[3.70477 -0.05156 -1.44613 -0.0265 0.0545 -0.48313 -0.39551 0.7011 0.3978 0.8061 ];
            case 11, C=[3.40112 -0.0621 -1.3577 0 0.0493 -0.65315 -0.44644 0.6922 0.3965 0.7977    ];
            case 12, C=[2.87449 -0.08126 -1.22665 0 0.0469 -0.82609 -0.4573 0.6897 0.3894 0.792    ];
            case 13, C=[2.40119 -0.09885 -1.11318 0 0.04 -0.89517 -0.43008 0.6971 0.4012 0.8043    ];
            case 14, C=[2.16953 -0.11604 -1.06795 0 0.0271 -0.94614 -0.37408 0.6751 0.4065 0.788   ];
            case 15, C=[1.38296 -0.14169 -0.92585 0 0.0141 -1.00786 -0.28957 0.6937 0.4011 0.8013  ];
            case 16, C=[0.94162 -0.16069 -0.86109 0 0 -1.01331 -0.28702 0.6922 0.3965 0.7977       ];
            case 17, C=[0.36315 -0.1879 -0.79498 0 0 -0.98071 -0.24695 0.7287 0.3821 0.8228        ];
            case 18, C=[-0.02806 -0.20666 -0.7626 0 -0.009 -0.91007 -0.17336 0.7333 0.3734 0.8229  ];
            case 19, C=[-0.64241 -0.23038 -0.73634 0 -0.0683 -0.85793 -0.13336 0.7051 0.4115 0.8164];
            case 20, C=[-0.93329 -0.25756 -0.7121 0 -0.2231 -0.75645 -0.07749 0.6241 0.3659 0.7235 ];
        end
    case 'rhyp'
        switch index
            case 1,  C=[ 6.72743 -0.11474 -1.17694 -0.0616 0.063 -0.72057 -0.19688 0.628 0.3312 0.71    ];
            case 2,  C=[ 3.26685 -0.04846 -1.47905 -0.1091 0.0937 -0.41997 -0.28846 0.6475 0.3472 0.7347];
            case 3,  C=[ 3.28656 -0.04784 -1.48197 -0.1115 0.0953 -0.41729 -0.28685 0.6492 0.3481 0.7366];
            case 4,  C=[ 3.38936 -0.04796 -1.50214 -0.104 0.1029 -0.39998 -0.28241 0.6543 0.3508 0.7424 ];
            case 5,  C=[ 3.53155 -0.04537 -1.52781 -0.0973 0.1148 -0.34799 -0.26842 0.6685 0.3526 0.7558];
            case 6,  C=[ 3.68895 -0.03991 -1.55693 -0.0884 0.1073 -0.27572 -0.24759 0.6816 0.3513 0.7668];
            case 7,  C=[ 3.86581 -0.0349 -1.58672 -0.0853 0.1052 -0.21231 -0.22385 0.6899 0.3659 0.7809 ];
            case 8,  C=[ 4.18224 -0.02826 -1.62527 -0.0779 0.0837 -0.14427 -0.17525 0.6881 0.3942 0.793 ];
            case 9,  C=[ 4.4375 -0.03256 -1.65601 -0.0749 0.0761 -0.27064 -0.29293 0.6936 0.4122 0.8068 ];
            case 10, C=[ 4.52949 -0.04509 -1.63467 -0.0265 0.0545 -0.48313 -0.39551 0.7048 0.3779 0.7997];
            case 11, C=[ 4.1775 -0.05565 -1.53574 0 0.0493 -0.65315 -0.44644 0.6954 0.3848 0.7948   ];
            case 12, C=[ 3.57698 -0.0749 -1.38832 0 0.0469 -0.82609 -0.4573 0.6934 0.3896 0.7954    ];
            case 13, C=[ 3.03752 -0.09243 -1.26045 0 0.04 -0.89517 -0.43008 0.7037 0.3894 0.8043    ];
            case 14, C=[ 2.77997 -0.10964 -1.20953 0 0.0271 -0.94614 -0.37408 0.6821 0.4017 0.7916  ];
            case 15, C=[ 1.91625 -0.13547 -1.05027 0 0.0141 -1.00786 -0.28957 0.7028 0.389 0.8033   ];
            case 16, C=[ 1.43982 -0.15427 -0.97812 0 0 -1.01331 -0.28702 0.7022 0.3826 0.7997       ];
            case 17, C=[ 0.83007 -0.18248 -0.90319 0 0 -0.98071 -0.24695 0.7378 0.3758 0.828        ];
            case 18, C=[ 0.40614 -0.20136 -0.86343 0 -0.009 -0.91007 -0.17336 0.7446 0.3676 0.8304  ];
            case 19, C=[ -0.22534 -0.22564 -0.83314 0 -0.0683 -0.85793 -0.13336 0.7154 0.4019 0.8206];
            case 20, C=[ -0.51893 -0.25256 -0.80922 0 -0.2231 -0.75645 -0.07749 0.6364 0.3318 0.7177];
        end
end
