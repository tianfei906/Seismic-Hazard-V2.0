function [lny,sigma,tau,phi]=BCHydro2018(To,M,Rrup,Ztor,Vs30,mechanism)

st = dbstack;
[isadmisible,units] = isIMadmisible(To,st(1).name,[0 10],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

To      = max(To,0.01);  % PGA is associated to To=0.01;
period  = [0.01 0.02 0.03 0.05 0.075 0.1 0.15 0.2 0.25 0.3 0.4 0.5 0.6 0.75 1 1.5 2 2.5 3 4 5 6 7.5 10];
T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6);    % Identify the period

if T_lo==T_hi
    [lny,sigma,tau,phi]=gmpe(index,M,Rrup,mechanism,Ztor,Vs30);
else
    [lny_lo,~,tau_lo,phi_lo] = gmpe(index,   M,Rrup,mechanism,Ztor,Vs30);
    [lny_hi,~,tau_hi,phi_hi] = gmpe(index+1, M,Rrup,mechanism,Ztor,Vs30);
    x          = log([T_lo;T_hi]);
    Y_sa       = [lny_lo,lny_hi]';
    Y_sigma2   = [tau_lo,tau_hi]';
    Y_sigma1   = [phi_lo,phi_hi]';
    lny        = interp1(x,Y_sa,log(To))';
    phi        = interp1(x,Y_sigma2,log(To))';
    tau        = interp1(x,Y_sigma1,log(To))';
    sigma      = sqrt(phi.^2+tau.^2);
end

% unit convertion
lny  = lny+log(units);

function[lny,sigma,tau,phi]=gmpe(index,M,R,mechanism,Z_TOR,Vs30)

CC = [
    10	8.20	7.2     1.18	1.88	865.1	-1.186	2.340	-1.044	0.1 	0.59	0	-0.00705	0	0	 0.4	1.73	0.0170	0.818	-0.0135   -0.223	0	   0	0.62	0.58
    10	8.20	7.2     1.18	1.88	865.1	-1.219	2.360	-1.044	0.1     0.59	0	-0.00707	0	0	 0.4	1.73	0.0170	0.857	-0.0135	  -0.196	0	   0	0.62    0.58
    10	8.20	7.2     1.18	1.88	907.8	-1.273	2.384	-1.08	0.1     0.59	0	-0.00710	0	0	 0.4	1.73	0.0170	0.921	-0.0135	  -0.128	0	   0	0.62	0.58
    10	8.20	7.2     1.18	1.88	1053.5	-1.346	2.446	-1.11	0.1     0.59	0	-0.00725	0	0	 0.4	1.73	0.0180	1.007	-0.0138	  -0.130	0      0	0.62	0.58
    10	8.20	7.2     1.18	1.88	1085.7	-1.471	2.751	-1.11	0.1     0.59	0	-0.00758	0	0	 0.4	1.73	0.0180	1.225	-0.0142   -0.130	0	   0	0.62	0.58
    10	8.20	7.2     1.18	1.88	1032.5	-1.624	3.019	-1.11	0.1     0.59	0	-0.00788	0	0	 0.4	1.73	0.0180	1.457	-0.0145	  -0.130	0      0	0.62	0.58
    10	8.20	7.2     1.18	1.88	877.6	-1.931	3.349	-1.084	0.1     0.59	0	-0.00820	0	0	 0.4	1.73	0.0175	1.849	-0.0153	  -0.156	0      0	0.62	0.56
    10	8.20	7.2     1.18	1.88	748.2	-2.188	3.284	-1.027	0.1     0.62	0	-0.00835	0	0	 0.4	1.73	0.0170	2.082	-0.0162	  -0.172	0      0	0.62	0.54
    10	8.20	7.2     1.18	1.88	654.3	-2.381	3.211	-0.983	0.1     0.64	0	-0.00835	0	0	 0.4	1.73	0.0160	2.240	-0.0172	  -0.184	0      0	0.62	0.52
    10	8.20	7.2     1.18	1.88	587.1	-2.518	3.145	-0.947	0.1     0.66	0	-0.00828	0	0	 0.4	1.73	0.0152	2.341	-0.0183	  -0.194	0      0	0.62	0.505
    10	8.20	7.2     1.18	1.88	503.0	-2.657	2.997	-0.89	0.1     0.68	0	-0.00797	0	0	 0.4	1.73	0.0140	2.415	-0.0206	  -0.210	0      0	0.62	0.48
    10	8.20	7.2     1.18	1.88	456.6	-2.669	2.839	-0.845	0.1     0.68	0	-0.00770	0	0	 0.4	1.73	0.0130	2.359	-0.0231	  -0.223	0      0	0.62	0.46
    10	8.20	7.2     1.18	1.88	430.3	-2.599	2.658	-0.809	0.1     0.68	0	-0.00740	0	0	 0.4	1.73	0.0122	2.227	-0.0256	  -0.233	0      0	0.62	0.45
    10	8.15	7.2     1.18	1.88	410.5	-2.401	2.346	-0.76	0.1     0.68	0	-0.00698	0	0	 0.4	1.73	0.0113	1.949	-0.0296	  -0.245	0      0	0.62	0.45
    10	8.10	7.2     1.18	1.88	400.0	-1.955	1.851	-0.698	0.1     0.68	0	-0.00645	0	0	 0.4	1.73	0.0100	1.402	-0.0363	  -0.261	0      0	0.62	0.45
    10	8.05	7.2     1.18	1.88	400.0	-1.025	1.216	-0.612	0.1     0.68	0	-0.00570	0	0	 0.4	1.73	0.0082	0.329	-0.0493	  -0.285	0      0	0.62	0.45
    10	8.00	7.2     1.18	1.88	400.0	-0.299	0.649	-0.55	0.1     0.68	0	-0.00510	0	0	 0.4	1.73	0.0070	-0.487	-0.061	  -0.301	0      0	0.62	0.45
    10	7.95	7.2     1.18	1.88	400.0	0.000	0.082	-0.501	0.1     0.68	0	-0.00465	0	0	 0.4	1.73	0.0060	-0.770	-0.0711	  -0.313	0      0	0.62	0.45
    10	7.90	7.2     1.18	1.88	400.0	0.000	-0.369	-0.46	0.1     0.68	0	-0.00430	0	0	 0.4	1.73	0.0052	-0.700	-0.0798	  -0.323	0      0	0.62	0.45
    10	7.85	7.2     1.18	1.88	400.0	0.000	-1.034	-0.455	0.1     0.68	0	-0.00390	0	0	 0.4	1.73	0.0040	-0.607	-0.0935	  -0.282	0      0	0.62	0.45
    10	7.80	7.2     1.18	1.88	400.0	0.000	-1.520	-0.45	0.1     0.73	0	-0.00370	0	0	 0.4	1.73	0.0030	-0.540	-0.098	  -0.250	0      0	0.62	0.45
    10	7.80	7.2     1.18	1.88	400.0	0.000	-1.810	-0.45	0.1     0.78	0	-0.00357	0	0	 0.4	1.73	0.0022	-0.479	-0.098	  -0.250	0      0	0.62	0.45
    10	7.80	7.2     1.18	1.88	400.0	0.000	-2.173	-0.45	0.1     0.84	0	-0.00340	0	0	 0.4	1.73	0.0013	-0.393	-0.098	  -0.250	0      0	0.62	0.45
    10	7.80	7.2     1.18	1.88	400.0	0.000	-2.712	-0.45	0.1     0.93	0	-0.00327	0	0	 0.4	1.73	0.0000	-0.350	-0.098	  -0.250	0      0	0.62	0.45
    ];

Adj = [1.04 1.05 1.23 1.34 1.32 1.32 1.21 1.14 1.05 0.95 0.79 0.66 0.54 0.36 0.24 -0.08 -0.21 -0.21 -0.22 -0.06 0.06 0.09 0.14 0.31
    0.83 0.79 0.71 0.98 0.99 1.00 0.92 0.88 0.81 0.75 0.62 0.54 0.46 0.33 0.23 -0.01 -0.09 -0.05 -0.02 0.06 0.06 0.10 0.13 0.24]';


switch mechanism
    case 'interface',F=0;
    case 'intraslab',F=1;
end
Vs = min(1000, Vs30);

% compute PGA1000
c           = CC(1,:);
C1          = F*c(3)+(1-F)*c(2);
f_mag       = c(11)*(M-C1)+c(20)*(10-M).^2;
f_mag(M>C1) = c(12)*(M(M>C1)-C1)+c(20)*(10-M(M>C1)).^2;
f_Z_TOR     = c(18)*(min(Z_TOR,100)-60)*F;
f_site      = (c(19)+c(7)*c(4))*log(1000/c(6));
ln_PGA      = c(8)+c(11)*(c(3)-c(2))*F+(c(9)+c(21)*F+c(10)*(M-7.8)).*log(R+c(1)*exp(c(16)*(M-6)))+ c(13)*R+c(17)*F+f_mag(1)+f_Z_TOR(1)+f_site;
if F == 0
    ln_PGA = ln_PGA+Adj(1,1);
else
    ln_PGA = ln_PGA+Adj(1,2);
end
PGA1000 = exp(ln_PGA);



c           = CC(index,:);
C1          = F*c(3)+(1-F)*c(2);
f_mag       = c(11)*(M-C1)+c(20)*(10-M).^2;
f_mag(M>C1) = c(12)*(M(M>C1)-C1)+c(20)*(10-M(M>C1)).^2;
f_Z_TOR     = c(18)*(min(Z_TOR,100)-60)*F;
if Vs30 < c(6)
    f_site = c(19).*log(Vs./c(6))-c(7).*log(PGA1000+c(5)) +c(7).*log(PGA1000+c(5).*((Vs./c(6)).^ c(4)));
else
    f_site = (c(19)+c(7)*c(4))*log(Vs./c(6));
end

lny   = c(8)+c(11).*(c(3)-c(2))*F+(c(9)+c(21)*F+c(10)*(M-7.8)).*log(R+c(1).*exp(c(16)*(M-6)))+ c(13)*R+c(17)*F+f_mag+f_Z_TOR+f_site;

if F == 0
    lny = lny + Adj(index,1);
else
    lny = lny + Adj(index,2);
end

phi   = c(24);
tau   = c(25);
sigma = sqrt(phi^2 + tau^2);    % It needs to be review.


