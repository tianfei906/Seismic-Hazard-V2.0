function [lny,sigma,tau,phi]=GKAS2017(To,M,Rrup,Rjb,Rx,Ry0,Ztor,dip,W,VS30,SOF,region,adjfun)
% Syntax : GKAS2017 SOF region                                              

st          = dbstack;
isadmisible = isIMadmisible(To,st(1).name,[0 10],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

if To>=0
    To  = max(To,0.01);  % PGA is associated to To=0.01;
end

period  = [0.01 0.02 0.03 0.05 0.075 0.1 0.15 0.2 0.25 0.3 0.4 0.5 0.75 1 1.5 2 3 4 5 6 7.5 10];

T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6);    % Identify the period

if T_lo==T_hi
    [lny,tau,phi] = gmpe(index,M,Rrup,Rjb,Rx,Ry0,Ztor,dip,W,VS30,SOF,region);
else
    [lny_lo,tau_lo,phi_lo] = gmpe(index,  M,Rrup,Rjb,Rx,Ry0,Ztor,dip,W,VS30,SOF,region);
    [lny_hi,tau_hi,phi_hi] = gmpe(index+1,M,Rrup,Rjb,Rx,Ry0,Ztor,dip,W,VS30,SOF,region);
    x          = log([T_lo;T_hi]);
    Y_sa       = [lny_lo,lny_hi]';
    Y_sigma2   = [tau_lo,tau_hi]';
    Y_sigma1   = [phi_lo,phi_hi]';
    lny        = interp1(x,Y_sa,log(To))';
    phi        = interp1(x,Y_sigma2,log(To))';
    tau        = interp1(x,Y_sigma1,log(To))';
end

sigma = sqrt(tau.^2+phi.^2);


% modifier
if exist('adjfun','var')
    SF  = feval(adjfun,To); 
    lny = lny+log(SF);
end

function[lny,tau,phi]=gmpe(index,M,Rrup,Rjb,Rx,Ry0,Ztor,dip,W,VS30,SOF,region)

switch SOF
    case 'strike-slip',     fRV = 0; fN=0;
    case 'normal',          fRV = 0; fN=1;
    case 'normal-oblique',  fRV = 0; fN=1;
    case 'reverse',         fRV = 1; fN=0;
    case 'reverse-oblique', fRV = 1; fN=0;
    case 'unspecified',     fRV = 0; fN=0;
end

if Rx==-999
    fHW = zeros(size(M));
else
    fHW    = sign(Rx);
end

C      = GKAS2017coefficients(index);
VLIN   = C(1);
c4     = C(2);
a1     = C(3);
a2     = C(4);
a3     = C(5);
a4     = C(6);
a5     = C(7);
a6     = C(8);
a8     = C(9); %#ok<NASGU>
a10    = C(10);
a11    = C(11);
a12    = C(12);
a13    = C(13);
% a14    = C(14);
a15    = C(15);
a17    = C(16);
a25    = C(17);
a26    = C(18);
a27    = C(19);
a28    = C(20);
a29    = C(21);
a31    = C(22);
a35    = C(23);
s1     = C(24);
s3     = C(26);

%"We recommend the use of set of s2NOJPs4NOJP coefficients for applications outside Japan."
s2 = C(28); %s2NOJP
s4 = C(29); %s4NOJP
if strcmp(region,'japan')
    s2     = C(25); %s2all
    s4     = C(27);
end


%% median model

% depth scaling
f6 = a15*Ztor/20;
f6(Ztor>=20)=a15;

% M dependent style of faulting
f7 = a11*(M-4); f7(M>5)=a11; f7(M<4)=0;
f8 = a12*(M-4); f8(M>5)=a12; f8(M<4)=0;

% hanging wall term
T1 = (90-max(dip,30))/45;
T2 = 1+0.2*(M-6.5)-0.8*(M-6.5).^2;
T2(M>=6.5)=1+0.2*(M(M>=6.5)-6.5);
T2(M<=5.5)=0;

R1  = W*cosd(dip);
R2  = 4*R1;
Ry1 = Rx*tand(20);
h1  = 0.25;
h2  = 1.5;
h3  = -0.75;

T3 = 1-(Rx-R1)/(R2-R1);
T3(Rx<R1)=h1+h2*Rx(Rx<R1)/R1+h3*(Rx(Rx<R1)/R1).^2;
T3(Rx>R2)=0;

T4 = 1-Ztor.^2/100;
T4(Ztor>=10)=0;

if ~ischar(Ry0)
    T5=1-(Ry0-Ry1)/5;
    T5(Ry0<Ry1)=1;
    T5(Ry0-Ry1>=5)=0;
else
    T5=1-Rjb/30;
    T5(Rjb==0)=1;
    T5(Rjb>=30)=0;
end

f4 = a13*T1*(T2.*T3).*(T4.*T5);
f4(isnan(f4))=0;

% Magnitude scaling term
c4M = c4-(c4-1)/2*(6-M);  % typo found in equation 13
c4M(M>6)=c4;
c4M(M<=4)=1;
M1  = 6.75;
M2  = 5.5;
R   = sqrt(Rrup.^2+c4M.^2);
f11 = a1+a5*(M-M1)  + (a2+a3*(M-M1)).*log(R)+a17*Rrup;
f1  = a1+a4*(M-M1)  + (a2+a3*(M-M1)).*log(R)+a17*Rrup;
f13 = a1+a4*(M2-M1) + (a2+a3*(M2-M1))*log(R)+a17*Rrup +a6*(M-M2);
f1(M>M1)=f11(M>M1);
f1(M<M2)=f13(M<M2);

% site amplification model
period  = [0.01 0.02 0.03 0.05 0.075 0.1 0.15 0.2 0.25 0.3 0.4 0.5 0.75 1 1.5 2 3 4 5 6 7.5 10];
T  = period(index);
V1 = exp(-0.35*log(T/0.5)+log(1500));
V1(T<=0.5)=1500;
V1(T>=3)=800;

if VS30<V1
    VS30a=VS30;
else
    VS30a=V1;
end

f5 = a10*log(VS30a/VLIN);

% regional amplification term
FTW = 0; FIT=0; FME =0; FCN=0;FJP=0;
switch region
    case 'global'
    case 'japan',       FJP=(a35*log(VS30a/VLIN)+a29*Rrup);
    case 'china',       FCN=(a28*Rrup);
    case 'italy',       FIT=(a31*log(VS30a/VLIN)+a26*Rrup); %error here. a32 set to a31, a32 is not given in the article
    case 'middle-east', FME=(a27*Rrup);
    case 'taiwan',      FTW=(a31*log(VS30a/VLIN)+a25*Rrup);
end
reg = FJP+FCN+FIT+FME+FTW;

% Mainshock - aftershock
fAS = 0;
f11 = 0;

lny = f1 + fRV*f7 + fN*f8 + fAS*f11 + f5 + fHW.*f4 + f6 + reg;

%% standard deviation
phi =s1+(s2-s1)/2*(M-4); phi(M<4)=s1; phi(M>6)=s2;
tau =s3+(s4-s3)/2*(M-5); tau(M<5)=s3; tau(M>7)=s4;

function[C]=GKAS2017coefficients(index)

switch index
    case 1, C=[660 8.6 1.35 -1.087 0.275 0.121 -0.592 1.78 0 -0.397 -0.2 -0.12 0.67 -0.168 1.1 -0.0062 0.0015 -0.0007 0.0031 0.0035 -0.001 0.252 0.38 0.734 0.52 0.44 0.35 0.45 0.322];
    case 2, C=[680 8.6 1.483 -1.106 0.275 0.111 -0.592 1.78 0 -0.36 -0.2 -0.12 0.67 -0.165 1.1 -0.0064 0.0017 -0.0007 0.0031 0.0035 -0.0009 0.215 0.343 0.734 0.54 0.455 0.359 0.473 0.333];
    case 3, C=[770 8.6 1.78 -1.15 0.275 0.105 -0.592 1.759 0 -0.34 -0.2 -0.12 0.67 -0.18 1.1 -0.0069 0.0016 -0.0008 0.0032 0.0037 -0.001 0.195 0.323 0.734 0.551 0.496 0.39 0.487 0.361];
    case 4, C=[915 8.6 1.965 -1.108 0.26 0.148 -0.559 1.708 0 -0.405 -0.2 -0.12 0.67 -0.212 1.1 -0.0092 0.0013 -0.0011 0.003 0.0047 -0.0006 0.26 0.388 0.734 0.565 0.537 0.46 0.504 0.411];
    case 5, C=[960 8.6 1.782 -1.006 0.247 0.202 -0.531 1.689 0 -0.46 -0.2 -0.12 0.67 -0.112 1.1 -0.0102 -0.0009 -0.0021 0.003 0.0054 -0.0009 0.315 0.443 0.734 0.577 0.508 0.468 0.504 0.395];
    case 6, C=[910 8.6 1.686 -0.952 0.239 0.258 -0.514 1.742 0 -0.474 -0.2 -0.12 0.67 -0.09 1.1 -0.0097 -0.0014 -0.0035 0.0026 0.0051 -0.0014 0.329 0.457 0.734 0.585 0.471 0.417 0.504 0.362];
    case 7, C=[740 8.6 1.609 -0.94 0.227 0.309 -0.488 1.831 0 -0.474 -0.159 -0.12 0.67 -0.075 1.1 -0.0075 -0.0014 -0.0045 0.002 0.0041 -0.0024 0.329 0.457 0.734 0.585 0.419 0.371 0.504 0.328];
    case 8, C=[590 8.6 1.484 -0.928 0.218 0.346 -0.469 1.937 0 -0.474 -0.129 -0.12 0.67 -0.075 1.1 -0.006 -0.0012 -0.0045 0.002 0.0038 -0.0029 0.329 0.457 0.71 0.585 0.396 0.339 0.504 0.306];
    case 9, C=[495 8.6 1.378 -0.928 0.211 0.374 -0.454 2.032 0 -0.474 -0.106 -0.12 0.62 -0.075 1.1 -0.0045 -0.0015 -0.0047 0.0015 0.0029 -0.0037 0.329 0.457 0.691 0.585 0.382 0.314 0.504 0.288];
    case 10,C=[430 8.6 1.309 -0.928 0.206 0.397 -0.443 2.109 0 -0.474 -0.088 -0.12 0.579 -0.075 1.031 -0.0036 -0.0015 -0.0044 0.0013 0.0025 -0.004 0.329 0.457 0.676 0.585 0.384 0.293 0.504 0.274];
    case 11,C=[360 8.6 1.124 -0.928 0.197 0.434 -0.352 2.227 0 -0.474 -0.059 -0.12 0.515 -0.075 0.922 -0.0024 -0.0015 -0.0034 0.0011 0.0016 -0.0041 0.329 0.457 0.651 0.585 0.4 0.261 0.504 0.252];
    case 12,C=[340 8.6 0.961 -0.928 0.19 0.462 -0.281 2.351 0 -0.49 -0.036 -0.12 0.465 -0.075 0.837 -0.0017 -0.0012 -0.0025 0.0007 0.0011 -0.0041 0.345 0.473 0.633 0.585 0.428 0.236 0.525 0.234];
    case 13,C=[330 8.6 0.648 -0.928 0.178 0.513 -0.152 2.577 0 -0.575 0.006 -0.12 0.374 -0.06 0.683 -0.001 -0.0002 -0.0006 0 0.0004 -0.0038 0.43 0.558 0.598 0.611 0.469 0.19 0.563 0.202];
    case 14,C=[330 8.6 0.402 -0.928 0.169 0.6 -0.061 2.7 0 -0.626 0.035 -0.12 0.31 0.017 0.574 -0.001 0 0 0 0.0004 -0.0031 0.481 0.609 0.574 0.629 0.5 0.19 0.59 0.18];
    case 15,C=[330 8.6 0.066 -0.928 0.157 0.838 0.068 2.821 0 -0.721 0.076 -0.12 0.219 0.147 0.42 -0.001 0 0 0 0.0004 -0.0023 0.576 0.704 0.54 0.656 0.534 0.19 0.628 0.184];
    case 16,C=[330 8.6 -0.248 -0.928 0.148 1.006 0.159 2.869 0 -0.73 0.106 -0.12 0.155 0.246 0.311 -0.001 0 0 0 0.0004 -0.0018 0.585 0.713 0.516 0.674 0.534 0.19 0.655 0.184];
    case 17,C=[330 8.6 -0.713 -0.928 0.136 1.244 0.288 2.92 0 -0.649 0.147 -0.12 0.064 0.385 0.157 -0.001 0 0 0 0.0004 -0.0018 0.504 0.632 0.481 0.7 0.534 0.19 0.693 0.184];
    case 18,C=[330 8.6 -1.057 -0.928 0.128 1.413 0.494 2.95 0 -0.575 0.176 -0.12 0 0.484 0.048 -0.001 0 0 0 0.0004 -0.0018 0.43 0.558 0.457 0.7 0.534 0.19 0.72 0.184];
    case 19,C=[330 8.6 -1.708 -0.848 0.121 1.544 0.654 2.95 0 -0.5 0.199 -0.12 0 0.561 -0.037 -0.001 0 0 0 0.0004 -0.0018 0.355 0.483 0.438 0.7 0.534 0.19 0.72 0.184];
    case 20,C=[330 8.6 -2.239 -0.783 0.115 1.651 0.784 2.95 0 -0.427 0.218 -0.12 0 0.624 -0.106 -0.001 0 0 0 0.0004 -0.0018 0.282 0.41 0.423 0.7 0.534 0.19 0.72 0.184];
    case 21,C=[330 8.6 -2.946 -0.704 0.109 1.78 0.943 2.95 0 -0.319 0.241 -0.12 0 0.7 -0.19 -0.001 0 0 0 0.0004 -0.0018 0.174 0.302 0.404 0.7 0.534 0.19 0.72 0.184];
    case 22,C=[330 8.6 -4.014 -0.6 0.1 1.95 1.15 2.95 0 -0.209 0.27 -0.12 0 0.8 -0.3 -0.001 0 0 0 0.0004 -0.0018 0.064 0.192 0.38 0.7 0.534 0.19 0.72 0.184];
end