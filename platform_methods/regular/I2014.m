function[lny,sigma,tau,phi]=I2014(To,M,Rrup,Vs30,SOF,adjfun)
% Syntax : I2014 SOF                                                        


st = dbstack;
[isadmisible,units] = isIMadmisible(To,st(1).name,[0 10],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

To      = max(To,0.001); 
period = [0.001 0.01 0.02 0.03 0.05 0.075 0.1 0.15 0.2 0.25 0.3 0.4 0.5 0.75 1 1.5 2 3 4 5 7.5 10];
T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6); % Identify the period
M(M>8.5)=NaN;
if T_lo==T_hi
    [lny,sigma] = gmpe(index,M,Rrup,SOF,Vs30);
else
    [lny_lo,sigma_lo] = gmpe(index,  M,Rrup,SOF,Vs30);
    [lny_hi,sigma_hi] = gmpe(index+1,M,Rrup,SOF,Vs30);
    x          = log([T_lo;T_hi]);
    Y_sa       = [lny_lo,lny_hi]';
    Y_sigma    = [sigma_lo,sigma_hi]';
    lny        = interp1(x,Y_sa,log(To))';
    sigma      = interp1(x,Y_sigma,log(To))';
end

tau   = nan(size(M));
phi   = nan(size(M));

% unit convertion
lny  = lny+log(units);

% modifier
if exist('adjfun','var')
    SF  = feval(adjfun,To); 
    lny = lny+log(SF);
end

function[lny,sigma]=gmpe(index,M,rrup,SOF,Vs30)

period = [0.001 0.01 0.02 0.03 0.05 0.075 0.1 0.15 0.2 0.25 0.3 0.4 0.5 0.75 1 1.5 2 3 4 5 7.5 10];
T = period(index);
if Vs30 > 1200
    Vs30 = 1200;
end

M_SE = max(min(M, 7.5),5);
if T <= 0.05
    sigma = 1.18 + 0.035 * log(0.05) - 0.06 * M_SE;
elseif T >= 3
    sigma = 1.18 + 0.035 * log(3) - 0.06 * M_SE;
else
    sigma = 1.18 + 0.035 * log(T) - 0.06 * M_SE;
end

switch SOF
    case 'strike-slip',     F=0;
    case 'normal',          F=0;
    case 'normal-oblique',  F=0;
    case 'reverse',         F=1;
    case 'reverse-oblique', F=1;
    case 'unspecified',     F=0;
end


Coef1 = [7.0887 7.0887 7.1157 7.2087 6.2638 5.9051 7.5791 8.019 9.2812 9.5804 9.8912 9.5342 9.2142 8.3517 7.0453 5.1307 3.361 0.1784 -2.4301 -4.357 -7.8275 -9.2857
0.2058 0.2058 0.2058 0.2058 0.0625 0.1128 0.0848 0.1713 0.1041 0.0875 0.0003 0.0027 0.0399 0.0689 0.16 0.2429 0.3966 0.756 0.9283 1.1209 1.4016 1.5574
2.9935 2.9935 2.9935 2.9935 2.8664 2.9406 3.019 2.7871 2.8611 2.8289 2.8423 2.83 2.856 2.7544 2.7339 2.68 2.6837 2.6907 2.5782 2.5468 2.4478 2.3922
-0.2287 -0.2287 -0.2287 -0.2287 -0.2418 -0.2513 -0.2516 -0.2236 -0.2229 -0.22 -0.2284 -0.2318 -0.2337 -0.2392 -0.2398 -0.2417 -0.245 -0.2389 -0.2514 -0.2541 -0.2593 -0.2586];
Coef2 = [9.0138 9.0138 9.0408 9.1338 7.9837 7.756 9.4252 9.6242 11.13 11.3629 11.7818 11.6097 11.4484 10.9065 9.8565 8.3363 6.8656 4.1178 1.8102 0.0977 -3.0563 -4.4387
-0.0794 -0.0794 -0.0794 -0.0794 -0.1923 -0.1614 -0.1887 -0.0665 -0.1698 -0.1766 -0.2798 -0.3048 -0.2911 -0.3097 -0.2565 -0.232 -0.1226 0.1724 0.3001 0.4609 0.6948 0.8393
2.9935 2.9935 2.9935 2.9935 2.7995 2.8143 2.8131 2.4091 2.4938 2.3773 2.3772 2.3413 2.3477 2.2042 2.1493 2.0408 2.0013 1.9408 1.7763 1.703 1.5212 1.4195
-0.2287 -0.2287 -0.2287 -0.2287 -0.2319 -0.2326 -0.2211 -0.1676 -0.1685 -0.1531 -0.1595 -0.1594 -0.1584 -0.1577 -0.1532 -0.147 -0.1439 -0.1278 -0.1326 -0.1291 -0.122 -0.1145];

a3   = [0.0589 0.0589 0.0589 0.0589 0.0417 0.0527 0.0442 0.0329 0.0188 0.0095 -0.0039 -0.0133 -0.0224 -0.0267 -0.0198 -0.0367 -0.0291 -0.0214 -0.0240 -0.0202 -0.0219 -0.0035];
zeta  = [ -0.854 -0.854 -0.854 -0.854 -0.631 -0.591 -0.757 -0.911 -0.998 -1.042 -1.030 -1.019 -1.023 -1.056 -1.009 -0.898 -0.851 -0.761 -0.675 -0.629 -0.531 -0.586];
gamma = [-0.0027 -0.0027 -0.0027 -0.0027 -0.0061 -0.0056 -0.0042 -0.0046 -0.0030 -0.0028 -0.0029 -0.0028 -0.0021 -0.0029 -0.0032 -0.0033 -0.0032 -0.0031 -0.0051 -0.0059 -0.0057 -0.0061];
phi   = [0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.08 0.06 0.04 0.02 0.02 0 0 0 0];

C1    = Coef1(:,index);
C2    = Coef2(:,index);
a1    = (M<=6.75)*C1(1)+and(6.75<M,M<=8.5)*C2(1);
a2    = (M<=6.75)*C1(2)+and(6.75<M,M<=8.5)*C2(2);
b1    = (M<=6.75)*C1(3)+and(6.75<M,M<=8.5)*C2(3);
b2    = (M<=6.75)*C1(4)+and(6.75<M,M<=8.5)*C2(4);
a3    = a3(index);
zeta  = zeta(index);
gamma = gamma(index);
phi   = phi(index);
lny   = a1 + a2 .* M + a3 .* (8.5 - M).^2 - (b1 + b2 .* M).* log(rrup + 10) + zeta .* log(Vs30) + gamma .* rrup + phi*F;

