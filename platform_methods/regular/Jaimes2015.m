function[lny,sigma,tau,phi]=Jaimes2015(To,M,Rrup,station,adjfun)

% Syntax : Jaimes2015 station                                               

% Jaimes M.A., Ramirez-Gaytán A. & Reinoso E (2015).Ground-Motion Prediction Model From Intermediate-Depth
% Intraslab Earthquakes at the Hill and Lake-Bed Zones of Mexico City. Journal of Earthquake Engineering,
% 19(8), 1260-1278, 2015

st = dbstack;
[isadmisible,units] = isIMadmisible(To,st(1).name,[0 5],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

if To>=0
   To      = max(To,0.01); %PGA is associated to To=0.01;
end
period  = [-1 0.01 0.2 0.4 0.6 0.8 1.0 1.2 1.4 1.6 1.8 2.0 2.2 2.4 2.6 2.8 3.0 3.2 3.4 3.6 3.8 4.0 4.2 4.4 4.6 4.8 5.0];
T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6); % Identify the period

if T_lo==T_hi
    [lny,sigma] = gmpe(index,M,Rrup,station);
else
    [lny_lo,sigma_lo] = gmpe(index,  M,Rrup,station);
    [lny_hi,sigma_hi] = gmpe(index+1,M,Rrup,station);
    x          = log([T_lo;T_hi]);
    Y_sa       = [lny_lo,lny_hi]';
    Y_sigma    = [sigma_lo,sigma_hi]';
    lny        = interp1(x,Y_sa,log(To))';
    sigma      = interp1(x,Y_sigma,log(To))';
end

% unit convertion
lny  = lny+log(units);
tau  = nan(size(M));
phi  = nan(size(M));

% modifier
if exist('adjfun','var')
    SF  = feval(adjfun,To); 
    lny = lny+log(SF);
end

function [lny,sigma]=gmpe(index,M,Rrup,station)

switch lower(station)
    case 'cu'
        DATA = [-3.9346 1.26 -1.00  0.0046 0.86
            -1.7918 1.61 -1.00 -0.0058 0.60
            -1.0515 1.67 -1.00 -0.0064 0.60
            -1.1719 1.61 -1.00 -0.0053 0.65
            -1.6592 1.65 -1.00 -0.0043 0.68
            -2.1755 1.66 -1.00 -0.0030 0.69
            -2.8579 1.73 -1.00 -0.0026 0.71
            -3.6313 1.82 -1.00 -0.0029 0.70
            -4.2636 1.90 -1.00 -0.0030 0.70
            -4.4998 1.89 -1.00 -0.0020 0.73
            -5.0084 1.92 -1.00 -0.0014 0.74
            -5.8253 2.02 -1.00 -0.0012 0.73
            -6.4277 2.13 -1.00 -0.0020 0.76
            -6.3898 2.08 -1.00 -0.0018 0.73
            -6.7080 2.08 -1.00 -0.0011 0.68
            -7.4660 2.17 -1.00 -0.0007 0.68
            -7.9145 2.22 -1.00 -0.0006 0.69
            -8.0307 2.22 -1.00 -0.0003 0.71
            -8.4523 2.27 -1.00 -0.0001 0.71
            -8.5683 2.29 -1.00 -0.0006 0.71
            -8.5162 2.28 -1.00 -0.0010 0.71
            -8.6208 2.29 -1.00 -0.0010 0.69
            -8.8196 2.30 -1.00 -0.0009 0.67
            -9.0254 2.33 -1.00 -0.0011 0.66
            -9.2106 2.35 -1.00 -0.0011 0.65
            -9.3389 2.36 -1.00 -0.0011 0.65
            -9.5327 2.37 -1.00 -0.0009 0.66];
    case 'sct'
        DATA=[-4.6123 1.78 -1.00 -0.0007  0.68
            0.4089 1.23 -1.00 -0.0016  0.55
            1.5834 1.21 -1.00 -0.0038  0.62
            1.3971 1.23 -1.00 -0.0033  0.67
            1.7297 1.22 -1.00 -0.0031  0.58
            1.0093 1.26 -1.00 -0.0024  0.49
            0.6566 1.27 -1.00 -0.0014  0.52
            0.8281 1.27 -1.00 -0.0013  0.54
            0.8742 1.29 -1.00 -0.0010  0.55
            0.3391 1.38 -1.00 -0.0004  0.58
            0.2631 1.37 -1.00  0.0002  0.58
            -1.3885 1.61 -1.00 -0.0002  0.65
            -1.9197 1.65 -1.00 -0.0002  0.65
            -2.6341 1.70 -1.00 -0.00004 0.63
            -3.0936 1.73 -1.00 -0.0002  0.62
            -3.6653 1.78 -1.00 -0.00003 0.60
            -4.1079 1.82 -1.00 -0.0001  0.59
            -4.2772 1.81 -1.00  0.00004 0.58
            -4.6434 1.84 -1.00 -0.00001 0.58
            -4.9558 1.87 -1.00 -0.0002  0.57
            -5.0802 1.88 -1.00 -0.0002  0.57
            -5.1961 1.88 -1.00 -0.0002  0.56
            -5.3332 1.88 -1.00 -0.0002  0.54
            -5.3795 1.87 -1.00 -0.0002  0.54
            -5.4828 1.87 -1.00 -0.0002  0.55
            -5.6267 1.88 -1.00 -0.0003  0.54
            -5.9359 1.93 -1.00 -0.0005  0.55 ];
    case 'cdao'
        DATA=[-5.4420 1.95 -1.00 -0.0013 0.57
            0.4656 1.22 -1.00 -0.0012 0.58
            1.4595 1.15 -1.00 -0.0021 0.62
            1.8145 1.20 -1.00 -0.0030 0.59
            2.1159 1.07 -1.00 -0.0010 0.54
            1.0506 1.21 -1.00 -0.0008 0.57
            2.7178 0.98 -1.00 -0.0001 0.59
            -0.4753 1.47 -1.00 -0.0009 0.59
            -1.7546 1.60 -1.00 -0.0008 0.55
            -1.7750 1.56 -1.00 -0.0003 0.55
            -1.9087 1.57 -1.00  0.0002 0.55
            -2.3207 1.64 -1.00  0.0003 0.55
            -2.3070 1.69 -1.00 -0.0002 0.56
            -2.4194 1.73 -1.00 -0.0002 0.56
            -2.5609 1.79 -1.00 -0.0004 0.55
            -3.4661 1.96 -1.00 -0.0008 0.55
            -4.3538 2.07 -1.00 -0.0006 0.56
            -5.1601 2.19 -1.00 -0.0009 0.53
            -6.0596 2.31 -1.00 -0.0010 0.53
            -6.6426 2.40 -1.00 -0.0017 0.54
            -6.9024 2.41 -1.00 -0.0018 0.55
            -7.1017 2.40 -1.00 -0.0016 0.55
            -6.9027 2.32 -1.00 -0.0013 0.55
            -6.8357 2.30 -1.00 -0.0015 0.54
            -6.9657 2.30 -1.00 -0.0016 0.54
            -7.2585 2.33 -1.00 -0.0017 0.52
            -7.4096 2.33 -1.00 -0.0017 0.51];
end

C       = DATA(index,:);
lny     = C(1)+ C(2)*M + C(3)*log(Rrup) + C(4)*Rrup;
sigma   = C(5)*ones(size(M));
