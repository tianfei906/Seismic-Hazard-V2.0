function [lny,sigma,tau,phi]= Kanno2006(To,M,Rrup,Zhyp,Vs30,adjfun)
% Syntax : Kanno2006                                                        

%Kanno, T., Narita, A., Morikawa, N., Fujiwara, H., & Fukushima, Y. (2006).
%A new attenuation relation for strong ground motion in Japan based on recorded data.
%Bulletin of the Seismological Society of America, 96(3), 879-897.

st = dbstack;
[isadmisible,units] = isIMadmisible(To,st(1).name,[0 5],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

if To>=0
    To      = max(To,0.01);
end
period  = [-1 0.01 0.05 0.06 0.07 0.08 0.09 0.10 0.11 0.12 0.13 0.15 0.17 0.20 0.22 0.25 0.30 0.35 0.40 0.45 0.50 0.60 0.70 0.80 0.90 1.00 1.10 1.20 1.30 1.50 1.70 2.00 2.20 2.50 3.00 3.50 4.00 4.50 5.00];
T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6);

if T_lo==T_hi
    [log10y,sigma] = gmpe(index,M,Rrup,Zhyp,Vs30);
else
    [log10y_lo,sigma_lo] = gmpe(index,M,Rrup,Zhyp,Vs30);
    [log10y_hi,sigma_hi] = gmpe(index+1,M,Rrup,Zhyp,Vs30);
    x           = log([T_lo;T_hi]);
    Y_sa        = [log10y_lo,log10y_hi]';
    Y_sigma     = [sigma_lo,sigma_hi]';
    log10y      = interp1(x,Y_sa,log(To))';
    sigma       = interp1(x,Y_sigma,log(To))';
end

% Base change
lny   = log10y*log(10);
sigma = sigma*log(10);
tau   = nan(size(M));
phi   = nan(size(M));

% unit convertion
lny  = lny+log(units);

% modifier
if exist('adjfun','var')
    SF  = feval(adjfun,To); 
    lny = lny+log(SF);
end

function [log10y,sigma]= gmpe(index,M,Rrup,Zhyp,Vs30)
[a1,b1,c1,d1,sigmas] = getcoeffs_shallow(index);
[a2,b2,c2,~,sigmad]  = getcoeffs_deep(index);
[p,q]                = getcoeffs_site(index);
G                    = (p.*log10(Vs30)+q);           % Additional correction termn corresponding to site effects

sigma(Zhyp<=30)=sigmas;
sigma(Zhyp>30)=sigmad;
sigma=sigma';

log10y_shallow     = a1*M + b1*Rrup - log10(Rrup+(d1*(10.^(0.5*M)))) + c1 + G;
log10y_deep        = a2*M + b2*Rrup - log10(Rrup) + c2 + G;

log10y(Zhyp<=30)=log10y_shallow(Zhyp<=30);
log10y(Zhyp>30) =log10y_deep(Zhyp>30);
log10y=log10y';

% If we want to apply the A term we should run the following algorith and comenting the algorithm from line 24-
% Rtr = Is the shortest distance from observation site to the Kuril, Japan, and Izu-Bonin trenches
%    [alpha,betha] = getcoeffs_japanomaly(index)
%    A = (alpha.*Rtr + betha).*(D-30);
%    lny=coeff_matrix(1,:).*Mw + coeff_matrix(2,:).*Rrup - log(Rrup+coeff_matrix(4,:).*10.^(0.5.*Mw)) + coeff_matrix(3,:) + coeff_matrix(5,:) + G + A;
%         sigma   =nan(size(M));  % Modificar
%         sigma1  =nan(size(M));  % Modificar
%         sigma2  =nan(size(M));  % Modificar


function [a1,b1,c1,d1,sigma]=getcoeffs_shallow(index)
COEFF_shallow=  [
    -1.00 	0.70 	-0.0009 	-1.93 	0.0022 	0.32
    0.00 	0.56 	-0.0031 	0.26 	0.0055 	0.37
    0.05 	0.54 	-0.0035 	0.48 	0.0061 	0.37
    0.06 	0.54 	-0.0037 	0.57 	0.0065 	0.38
    0.07 	0.53 	-0.0039 	0.67 	0.0066 	0.38
    0.08 	0.52 	-0.0040 	0.75 	0.0069 	0.39
    0.09 	0.52 	-0.0041 	0.80 	0.0071 	0.40
    0.10 	0.52 	-0.0041 	0.85 	0.0073 	0.40
    0.11 	0.50 	-0.0040 	0.96 	0.0061 	0.40
    0.12 	0.51 	-0.0040 	0.93 	0.0062 	0.40
    0.13 	0.51 	-0.0039 	0.91 	0.0062 	0.40
    0.15 	0.52 	-0.0038 	0.89 	0.0060 	0.41
    0.17 	0.53 	-0.0037 	0.84 	0.0056 	0.41
    0.20 	0.54 	-0.0034 	0.76 	0.0053 	0.40
    0.22 	0.54 	-0.0032 	0.73 	0.0048 	0.40
    0.25 	0.54 	-0.0029 	0.66 	0.0044 	0.40
    0.30 	0.56 	-0.0026 	0.51 	0.0039 	0.39
    0.35 	0.56 	-0.0024 	0.42 	0.0036 	0.40
    0.40 	0.58 	-0.0021 	0.26 	0.0033 	0.40
    0.45 	0.59 	-0.0019 	0.13 	0.0030 	0.41
    0.50 	0.59 	-0.0016 	0.04 	0.0022 	0.41
    0.60 	0.62 	-0.0014 	-0.22 	0.0025 	0.41
    0.70 	0.63 	-0.0012 	-0.37 	0.0022 	0.41
    0.80 	0.65 	-0.0011 	-0.54 	0.0020 	0.41
    0.90 	0.68 	-0.0009 	-0.80 	0.0019 	0.41
    1.00 	0.71 	-0.0009 	-1.04 	0.0021 	0.41
    1.10 	0.72 	-0.0007 	-1.19 	0.0018 	0.41
    1.20 	0.73 	-0.0006 	-1.32 	0.0014 	0.41
    1.30 	0.74 	-0.0006 	-1.44 	0.0014 	0.41
    1.50 	0.77 	-0.0005 	-1.70 	0.0017 	0.40
    1.70 	0.79 	-0.0005 	-1.89 	0.0019 	0.39
    2.00 	0.80 	-0.0004 	-2.08 	0.0020 	0.39
    2.20	0.82 	-0.0004 	-2.24 	0.0022 	0.38
    2.50	0.84 	-0.0003 	-2.46 	0.0023 	0.38
    3.00 	0.86 	-0.0002 	-2.72 	0.0021	0.38
    3.50 	0.90 	-0.0003 	-2.99 	0.0032	0.37
    4.00 	0.92 	-0.0005 	-3.21 	0.0045 	0.38
    4.50 	0.94 	-0.0007 	-3.39 	0.0064 	0.38
    5.00 	0.92 	-0.0004 	-3.35 	0.0030 	0.38];
a1 = COEFF_shallow(index,2);
b1 = COEFF_shallow(index,3);
c1 = COEFF_shallow(index,4);
d1 = COEFF_shallow(index,5);
sigma = COEFF_shallow(index,6);


function [a2,b2,c2,d2,sigma]=getcoeffs_deep(index)
COEFF_deep=[
    -1.0	0.55 	-0.0032 	-0.57 	0.00    0.36
    0.00 	0.41 	-0.0039 	1.56 	0.00    0.40
    0.05 	0.39 	-0.0040 	1.76 	0.00    0.42
    0.06 	0.39 	-0.0041 	1.86 	0.00    0.43
    0.07 	0.38 	-0.0042 	1.96 	0.00    0.45
    0.08 	0.38 	-0.0042 	2.03 	0.00    0.45
    0.09 	0.38 	-0.0043 	2.08 	0.00    0.46
    0.10 	0.38 	-0.0043 	2.12 	0.00    0.46
    0.11 	0.38 	-0.0044 	2.14 	0.00    0.46
    0.12 	0.38 	-0.0044 	2.14 	0.00    0.46
    0.13 	0.38 	-0.0044 	2.13 	0.00    0.46
    0.15 	0.39 	-0.0044 	2.12 	0.00    0.46
    0.17 	0.40 	-0.0043 	2.08 	0.00    0.45
    0.20 	0.40 	-0.0042 	2.02 	0.00    0.44
    0.22 	0.40 	-0.0041 	1.99 	0.00    0.43
    0.25 	0.41 	-0.0040 	1.88 	0.00    0.42
    0.30 	0.43 	-0.0038 	1.75 	0.00    0.42
    0.35 	0.43 	-0.0036 	1.62 	0.00    0.41
    0.40 	0.45 	-0.0034 	1.49 	0.00    0.41
    0.45 	0.46 	-0.0032 	1.33 	0.00    0.41
    0.50 	0.47 	-0.0030 	1.19 	0.00    0.40
    0.60 	0.49 	-0.0028 	0.95 	0.00    0.40
    0.70 	0.51 	-0.0026 	0.72 	0.00    0.40
    0.80 	0.53 	-0.0025 	0.49 	0.00    0.40
    0.90 	0.56 	-0.0023 	0.27 	0.00    0.40
    1.00 	0.57 	-0.0022 	0.08 	0.00    0.41
    1.10 	0.59 	-0.0022 	-0.08 	0.00    0.41
    1.20 	0.60 	-0.0021 	-0.24 	0.00    0.41
    1.30 	0.62 	-0.0020 	-0.40 	0.00    0.41
    1.50 	0.64 	-0.0020 	-0.63 	0.00    0.41
    1.70 	0.66 	-0.0018 	-0.83 	0.00    0.40
    2.00 	0.68 	-0.0017 	-1.12 	0.00    0.40
    2.20 	0.69 	-0.0017 	-1.27 	0.00    0.40
    2.50 	0.71 	-0.0017 	-1.48 	0.00    0.39
    3.00 	0.73 	-0.0017 	-1.72 	0.00    0.39
    3.50 	0.75 	-0.0017 	-1.97 	0.00    0.38
    4.00 	0.77 	-0.0016 	-2.22 	0.00    0.37
    4.50 	0.79 	-0.0016 	-2.45 	0.00    0.36
    5.00 	0.82 	-0.0017 	-2.70 	0.00    0.35];
a2 = COEFF_deep(index,2);
b2 = COEFF_deep(index,3);
c2 = COEFF_deep(index,4);
d2 = COEFF_deep(index,5);
sigma = COEFF_deep(index,6);

function [p,q] = getcoeffs_site(index)
COEFF=  [-0.71 1.77
    -0.55 1.35
    -0.32 0.80
    -0.26 0.65
    -0.24 0.60
    -0.26 0.64
    -0.29 0.72
    -0.32 0.78
    -0.35 0.84
    -0.39 0.94
    -0.43 1.04
    -0.53 1.28
    -0.61 1.47
    -0.68 1.65
    -0.72 1.74
    -0.75 1.82
    -0.80 1.96
    -0.85 2.09
    -0.87 2.13
    -0.89 2.18
    -0.91 2.25
    -0.92 2.30
    -0.96 2.41
    -0.98 2.46
    -0.97 2.44
    -0.93 2.32
    -0.92 2.30
    -0.91 2.26
    -0.88 2.20
    -0.85 2.12
    -0.83 2.06
    -0.78 1.92
    -0.76 1.88
    -0.72 1.80
    -0.68 1.70
    -0.66 1.64
    -0.62 1.54
    -0.60 1.50
    -0.59 1.46];
p=COEFF(index,1);
q=COEFF(index,2);

%function [alpha,betha] =getcoeffs_japanomaly(index)
% COEFF=[ 1.94*10^5 	7.24*10^3
%         6.73*10^5 	2.09*10^2
%         7.78*10^5 	2.37*10^2
%         8.02*10^5 	2.42*10^2
%         8.15*10^5 	2.47*10^2
%         8.22*10^5 	2.50*10^2
%         8.26*10^5 	2.55*10^2
%         8.23*10^5 	2.54*10^2
%         8.18*10^5 	2.56*10^2
%         8.08*10^5 	2.53*10^2
%         7.99*10^5 	2.51*10^2
%         7.99*10^5 	2.51*10^2
%         7.53*10^5 	2.38*10^2
%         6.99*10^5 	2.23*10^2
%         6.54*10^5 	2.09*10^2
%         6.07*10^5 	1.96*10^2
%         5.47*10^5 	1.78*10^2
%         5.06*10^5 	1.67*10^2
%         4.62*10^5 	1.54*10^2
%         4.62*10^5 	1.51*10^2
%         4.41*10^5 	1.44*10^2
%         3.60*10^5 	1.19*10^2
%         2.88*10^5 	9.48*10^3
%         2.50*10^5 	8.19*10^3
%         2.16*10^5 	7.35*10^3
%         2.18*10^5 	7.61*10^3
%         1.95*10^5 	7.08*10^3
%         1.63*10^5 	6.52*10^3
%         1.38*10^5 	5.85*10^3
%         1.18*10^5 	5.52*10^3
%         8.53*10^6 	4.80*10^3
%         4.53*10^6 	4.05*10^3
%         1.18*10^6 	3.11*10^3
%         2.60*10^6 	2.15*10^3
%         3.01*10^6 	2.01*10^3
%         2.49*10^6 	2.06*10^3
%         9.28*10^6 	2.27*10^3
%         2.13*10^6 	2.95*10^3
%         4.61*10^6 	3.44*10^3];
% alpha = (index,1);
% betha = (index,2);
%
% end