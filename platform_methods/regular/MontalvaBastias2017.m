function[lny,sigma,tau,phi]=MontalvaBastias2017(To,M,Rrup,Rhyp,Zhyp,Vs30,mechanism,arc,adjfun)

% Syntax : MontalvaBastias2017 mechanism arc                                

% Montalva, G., Bastias, N., Rodriguez-Marek, A. (2016) Ground Motion
% Prediction Equation for the Chilean Subduction Zone. Bulletin of the 
% Seismological Society of America April 2017 vol. 107 no. 2 901-911
% Includes correction (erratum)
% Erratum to Ground-Motion Prediction Equation for the Chilean Subduction 
% Zone. Bulletin of the Seismological Society of America, Vol. 107, No. 5, 
% pp. 2541–2541, October 2017, doi: 10.1785/0120170189

st = dbstack;
[isadmisible,units] = isIMadmisible(To,st(1).name,[0 10],[nan nan],[nan nan],[nan nan]);
if isadmisible==0
    lny   = nan(size(M));
    sigma = nan(size(M));
    tau   = nan(size(M));
    phi   = nan(size(M));
    return
end

To      = max(To,0.01); %PGA is associated to To=0.01;
period  = [0.01;0.02; 0.05; 0.075; 0.1; 0.15; 0.2; 0.25; 0.3; 0.4; 0.5; 0.6; 0.75; 1; 1.5; 2; 2.5; 3; 4; 5; 6; 7.5; 10];
T_lo    = max(period(period<=To));
T_hi    = min(period(period>=To));
index   = find(abs((period - T_lo)) < 1e-6); % Identify the period

switch mechanism
    case 'interface', R=Rrup;
    case 'intraslab', R=Rhyp;
end

if T_lo==T_hi
    [lny,sigma,tau,phi] = gmpe(index,M,R,Zhyp,mechanism,arc,Vs30);
else
    [lny_lo,sigma_lo,tau_lo] = gmpe(index,  M,R,Zhyp,mechanism,arc,Vs30);
    [lny_hi,sigma_hi,tau_hi] = gmpe(index+1,M,R,Zhyp,mechanism,arc,Vs30);
    x          = log([T_lo;T_hi]);
    Y_sa       = [lny_lo,lny_hi]';
    Y_sigma    = [sigma_lo,sigma_hi]';
    Y_tau      = [tau_lo,tau_hi]';
    lny        = interp1(x,Y_sa,log(To))';
    sigma      = interp1(x,Y_sigma,log(To))';
    tau        = interp1(x,Y_tau,log(To))';
    phi        = sqrt(sigma.^2-tau.^2);
end

% unit convertion
lny  = lny+log(units);

% modifier
if exist('adjfun','var')
    SF  = feval(adjfun,To); 
    lny = lny+log(SF);
end

function[lnSa,sigma,tau,sig]=gmpe(index,M,R,h,mechanism,arc,Vs30)

tdc1 = [
    -0.3    0.2
    -0.3    0.2
    -0.3	0.2
    -0.3	0.2
    -0.3	0.2
    -0.3	0.2
    -0.3	0.2
    -0.3	0.2
    -0.3	0.2
    -0.3	0.143682921
    -0.3	0.1
    -0.3	0.073696559
    -0.3	0.04150375
    -0.3	0
    -0.3	-0.05849625
    -0.3	-0.1
    -0.3	-0.155033971
    -0.3	-0.2
    -0.3	-0.2
    -0.3	-0.2
    -0.3	-0.2
    -0.3	-0.2
    -0.3	-0.2
    ];

%% FFABA
switch lower(arc)
    case 'forearc', F_FABA = 0; 
    case 'backarc', F_FABA = 1;
    case 'unknown', F_FABA = 0; 
end

%% FEVENT
switch lower(mechanism)
    case 'interface'
        F_event = 0;
        DC1table = tdc1(:,2);
    case 'intraslab'
        F_event = 1;
        DC1table = tdc1(:,1);
end

%%

% Regresion Coefficients
COEFF = [
% Coefficients obtained from Abrahamson, 2015
%   c4         C1          DC1           n           c          vlin               b       th(1)       th(2)      th(3)	       th(4)       th(5)        th(6)      th(7)	     th(8)     th(9)       th(10)	  th(11)	  th(12)	  th(13)	   th(14)	  th(15)	    th(16)	    phi        tau      sigma_total   phi_S2S
10 7.2 0 1.18 1.88 865.1 -1.18600000	5.87504394	-1.75359772	0.13125248	0.80276784	-0.33486952	-0.00039095	1.09880000	-1.42 0.4 4.53143081	0.00567350	1.01494528	0 -0.73080261	0.99690000	-1 0.69118080	0.47462209	0.83844918	0.56436373
10 7.2 0 1.18 1.88 865.1 -1.18600000	5.97631438	-1.77010766	0.12246057	0.84131709	-0.28054559	-0.00038903	1.09880000	-1.42 0.4 4.57416129	0.00565448	1.03738201	0 -0.73868917	0.99690000	-1 0.69938258	0.47631913	0.84617723	0.57187735
10 7.2 0 1.18 1.88 1053.5 -1.34600000	7.45297044	-2.03336398	0.08332151	1.03131243	-0.03954116	0 1.25360000	-1.65 0.4 4.56070915	0.00848068	1.31034079	0 -0.69848828	1.10300000	-1.18 0.70173433	0.53776165	0.88409200	0.57850117
10 7.2 0 1.18 1.88 1085.7 -1.47100000	8.04759521	-2.10610081	0.08012671	1.03436999	-0.01295063	-0.00009638	1.41750000	-1.8 0.4 4.36639286	0.00921589	1.48158019	0 -0.65335577	1.27320000	-1.36 0.71412373	0.56188074	0.90867082	0.59936738
10 7.2 0 1.18 1.88 1032.5 -1.62400000	7.76085108	-1.99370934	0.07303120	1.07565004	0.00758131	-0.00078515	1.39970000	-1.8 0.4 3.90922953	0.00629627	1.65618649	0 -0.55051160	1.30420000	-1.36 0.74112800	0.52707475	0.90943856	0.63409914
10 7.2 0 1.18 1.88 877.6 -1.93100000	6.17191900	-1.58654201	0.05481839	1.17061492	0.10490549	-0.00267532	1.35820000	-1.69 0.4 3.06236311	0.00558843	1.93944484	0 -0.42997222	1.26 -1.3 0.74606525	0.50642417	0.90170882	0.63021739
10 7.2 0 1.18 1.88 748.2 -2.18800000	4.83403302	-1.29711030	0.05249728	1.20531288	0.17968066	-0.00337590	1.16480000	-1.49 0.4 3.50112817	0.00319554	2.08901131	0 -0.53087673	1.22300000	-1.25 0.74515270	0.44618739	0.86852504	0.61699385
10 7.2 0 1.18 1.88 654.3 -2.38100000	4.42687615	-1.18774055	0.02995137	1.37607187	0.22912175	-0.00355237	0.99400000	-1.3 0.4 3.62815675	0.00181700	2.25003086	0 -0.58085678	1.16 -1.17 0.72855743	0.45040229	0.85653847	0.58609155
10 7.2 0 1.18 1.88 587.1 -2.51800000	4.57008643	-1.24895678	0.03865827	1.34990775	0.15592549	-0.00244847	0.88210000	-1.18 0.4 3.87633808	0.00212947	2.28338700	0 -0.66280655	1.05 -1.06 0.72093248	0.42549471	0.83713164	0.57014335
10 7.2 0 1.18 1.88 503 -2.65700000	3.98311294	-1.13377346	0.04682762	1.37953880	0.11670946	-0.00207613	0.70460000	-0.98 0.4 4.03388062	0.00068979	2.31408730	0 -0.72244113	0.8 -0.78 0.71005053	0.42945015	0.82981877	0.54795548
10 7.2 0 1.18 1.88 456.6 -2.66900000	4.86034340	-1.38019755	0.03822425	1.51949871	0.18347677	-0.00001896	0.57990000	-0.82 0.4 4.31418239	0.00064780	2.33333479	0 -0.79644275	0.66200000	-0.62 0.66934213	0.43333698	0.79737057	0.49113105
10 7.2 0 1.18 1.88 430.3 -2.59900000	4.67510367	-1.35362409	0.02523729	1.66662746	0.21967977	0 0.50210000	-0.7 0.4 4.75196667	0.00087070	2.23421777	0 -0.90120145	0.58 -0.5 0.66733247	0.44599448	0.80264793	0.49077603
10 7.2 0 1.18 1.88 410.5 -2.40100000	4.30862113	-1.30799859	0.00995253	1.85625091	0.29782648	0 0.36870000	-0.54 0.4 4.70451938	-0.00031282	2.05217228	0 -0.89829099	0.48 -0.34 0.66329494	0.46723155	0.81133563	0.48213254
10 7.2 0 1.18 1.88 400 -1.95500000	3.57339281	-1.23082022	0.03605351	1.81217177	0.24372341	0 0.17460000	-0.34 0.4 4.56020155	-0.00101097	1.63506217	0 -0.87330858	0.33 -0.14 0.63504015	0.50143305	0.80914220	0.45955396
10 7.2 0 1.18 1.88 400 -1.02500000	2.92216459	-1.18750273	0.02768934	2.03469107	0.22521403	-0.00009996	-0.08200000	-0.05 0.4 4.83342978	0.00009741	0.69338467	0 -0.94685865	0.31 0 0.60012607	0.51633193	0.79167542	0.42572864
10 7.2 0 1.18 1.88 400 -0.29900000	2.39779653	-1.16319283	0.04011300	2.04340485	0.27382886	-0.00033356	-0.28210000	0.12 0.4 4.59028522	0.00108512	-0.09761879	0 -0.90845421	0.3 0 0.56961713	0.50688464	0.76249309	0.40178822
10 7.2 0 1.18 1.88 400 0 1.64147667	-1.06543862	0.08310064	1.88987024	0.18739875	-0.00121364	-0.41080000	0.25 0.4 4.13415056	0.00035459	-0.34931995	0 -0.80518214	0.3 0 0.55384735	0.51465398	0.75605265	0.39825312
10 7.2 0 1.18 1.88 400 0 1.66482796	-1.12677535	0.09403648	1.90503920	0.13268085	-0.00087595	-0.44660000	0.3 0.4 4.18978319	0.00072950	-0.33269783	0 -0.81689247	0.3 0 0.53658882	0.50365207	0.73593000	0.38493023
10 7.2 0 1.18 1.88 400 0 0.90564754	-1.07619985	0.13838017	1.71178342	0.01379686	-0.00061861	-0.43440000	0.3 0.4 4.50906779	0.00084112	-0.41320697	0 -0.87331394	0.3 0 0.51345287	0.45311429	0.68479662	0.35578953
10 7.2 0 1.18 1.88 400 0 0.61234440	-1.13079589	0.15259121	1.59358719	0.06464958	0 -0.43680000	0.3 0.4 4.56385964	0.00068188	-0.42395126	0 -0.87800447	0.3 0 0.51417184	0.43900131	0.67608789	0.34990851
10 7.2 0 1.18 1.88 400 0 0.32672294	-1.15734380	0.12420910	1.69183532	0.32368231	0 -0.45860000	0.3 0.4 4.55836575	0.00137322	-0.38759507	0 -0.88436295	0.3 0 0.49080507	0.42084190	0.64652728	0.32047977
10 7.2 0 1.18 1.88 400 0 -0.24139803	-1.14070070	0.10950824	1.71125604	0.60252124	0 -0.44330000	0.3 0.4 5.08281865	0.00167053	-0.32638288	0 -0.98803311	0.3 0 0.47063810	0.41701232	0.62880800	0.29895226
10 7.2 0 1.18 1.88 400 0 -0.96313983	-1.09295336	0.11343926	1.67160339	0.77620830	0 -0.48280000	0.3 0.4 5.49692364	-0.00070392	-0.25811162	0 -1.05008478	0.3 0 0.46023151	0.38872242	0.60242690	0.28453650
];  


c   = COEFF(index,:);
DC1 = DC1table(index,:);

c0   = COEFF(1,:);
DC10 = DC1table(1);

% f_mag
C1 = c(1,2);
theta4 = (M <= C1 + DC1) * c(11);
theta5 = (M >  C1 + DC1) * c(12);
theta_45 = theta4 + theta5;
%theta13 = c(20); %equal to 0 for all periods

f_mag = theta_45.*(M-(C1 + DC1));% + theta13*(10-M).^2;

% f_depth
theta11 = c(18);
H = min(h,120);
f_depth = theta11 * (H - 60) * F_event;

% f_faba
theta7  = c(14);
theta8  = c(15);
theta15 = c(22);
theta16 = c(23);
if F_event == 1
    f_faba = (theta7  +  theta8*log(max(R, 85)/40))*F_FABA;
else % if F_event == 0
    f_faba = (theta15 + theta16*log(max(R,100)/40))*F_FABA;
end

% f_site
Vs = min(1000, Vs30); % (equation (8))
V_lin   = c(6);
theta12 = c(19);
b       = c(7);
cc      = c(5);
n       = c(4);

% Calculate PGA1000, i.e. the median (epsilon = 0) PGA (i.e. period=0.01)
% value when VS30 = 1000 m/s is used.  To do this, calculate f_site for
% VS30 =1000 m/s, then calculate all "Sa"s and use the one corresponding to
% T=0.01 sec, as that is what is used for PGA. (done for ease of
% calculation, we could've just calculated the PGA value)
f_site = c0(19) .* log(1000./c0(6)) + c0(7) .* c0(4) .* log(1000./c0(6));
C10    = c0(1,2);
theta40 = (M <= C10 + DC10) * c0(11);
theta50 = (M >  C10 + DC10) * c0(12);
theta_450 = theta40 + theta50;
%theta130 = c0(20); %equal to 0 for all periods
f_mag0 = theta_450.*(M-(C10 + DC10));% + theta130*(10-M).^2;
theta110 = c0(18);
f_depth0 = theta110 * (H - 60) * F_event;
f_path=(c0(9) + c0(21)*F_event  + c0(10).* (M-7.2)) .*log(R + c0(1).* exp((M-6)*c0(16)))+ c0(13)*R;
ln_Sa = c0(8) + c0(11).*DC10 + f_path + c0(17)*F_event + f_mag0 + f_depth0 + f_faba + f_site;
PGA1000 = exp(ln_Sa);

% Now, with the PGA1000 obtained, recalculate f_site and Sa for all periods
if Vs30  >   V_lin
    f_site = (theta12 .* log(Vs./V_lin) + b .* n .* log(Vs./V_lin)).*ones(size(M));
else
    f_site = theta12 .* log(Vs./V_lin) - b .* log(PGA1000 + cc) + b .* log(PGA1000 + cc .* ((Vs./V_lin) .^ n));
end

% Now we have all parameters, calculate SA and export deviations
sig   = c(24)*ones(size(R));
tau   = c(25)*ones(size(R));
sigma = sqrt(sig.^2 + tau.^2); % More accurate than column c(:,26)
lnSa  = c(8) + c(11)*DC1 + (c(9) + c(21)*F_event  + c(10)* (M-7.2)).*log(R + c(1)* exp((M-6)*c(16)))+ c(13)*R + c(17)*F_event + f_mag + f_depth + f_faba + f_site;
   
